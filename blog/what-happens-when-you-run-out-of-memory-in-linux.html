<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>What happens when you run out of memory in Linux?</title>
        <link rel="stylesheet" href="http://pminkov.github.io/blog/theme/css/main.css" />
        <link href="http://pminkov.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Petko's Coding Blog Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://pminkov.github.io/blog/">Petko's Coding Blog </a></h1>
                <nav><ul>
                    <li><a href="http://pminkov.github.io/blog/category/cloud.html">Cloud</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/django.html">Django</a></li>
                    <li class="active"><a href="http://pminkov.github.io/blog/category/linux.html">Linux</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/machine-learning.html">Machine Learning</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/misc.html">Misc</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://pminkov.github.io/blog/what-happens-when-you-run-out-of-memory-in-linux.html" rel="bookmark"
           title="Permalink to What happens when you run out of memory in Linux?">What happens when you run out of memory in Linux?</a></h1>
    </header>

    <div class="entry-content">
<div class="post-info">
        <abbr class="published" title="2017-01-15T12:50:00-08:00">
                Published: Sun 15 January 2017
in <a href="http://pminkov.github.io/blog/category/linux.html">Linux</a>
        </abbr>

</div><!-- /.post-info -->    </div>
    <div>
      <p>I've always been curious to figure out what happens when you run out of memory in Linux and recently I was experimenting with something that helped me figure it out. </p>
<p>I was trying out <a href="http://dhbox.org/">dhbox</a> deployment on an EC2 machine. dhbox allows you to start a virtual environment in which you can try out various data science tools. These virtual environments are run on Docker containers. These Docker containers take a lot of memory, so you can't run too many on a single machine. So far so good. But let's see what actually happens.</p>
<p>Before we start, <a href="http://techblog.netflix.com/2015/11/linux-performance-analysis-in-60s.html">here</a> is a great document from the Netflix Eng blog that describes the tools that can be used to debug a slow Linux box. </p>
<p>I deployed DHBox on an Ubuntu image in EC2 with 1GB of memory and no swap file. Yes, no swap file. Why? It seems like that's done, because having a swap file might incur a lot of EBS IO, which leads to high pricing. But still, this makes for an interesting debugging scenario, so let's continue.</p>
<p>Here's what our free memory situation is in the beginnging:</p>
<div class="highlight"><pre><span></span>$ free -m
              total        used        free      shared  buff/cache   available
Mem:            <span class="m">990</span>          <span class="m">78</span>         <span class="m">518</span>           <span class="m">4</span>         <span class="m">392</span>         867
Swap:             <span class="m">0</span>           <span class="m">0</span>           0
</pre></div>


<p>Notice how we have 392MB in "buff/cache". What is this? <a href="http://www.tldp.org/LDP/sag/html/buffer-cache.html">Here</a> is a good explanation of it. The buffer cache is caching (in RAM) data that's on disk. For example, the "ls" command, or the glibc library are things that are often used and are good candidates for caching.</p>
<p>The first thing I do is to start the Python web app for DHBox. It's a simple Flask app running on <a href="http://gunicorn.org/">gunicorn</a>. After I start it, this is what <code>free</code> is showing:</p>
<div class="highlight"><pre><span></span>$ free -m
              total        used        free      shared  buff/cache   available
Mem:            <span class="m">990</span>         <span class="m">127</span>         <span class="m">453</span>           <span class="m">4</span>         <span class="m">410</span>         818
Swap:             <span class="m">0</span>           <span class="m">0</span>           0
</pre></div>


<p>Reasonable. We are using a bit more memory, we have cached a bit more data from disk.</p>
<p>Now, I'll start running vmstat and run four virtual labs. This seems to be enough to take 1GB of memory and pretty much bring down the machine. One other tool we're going to use is <code>vmstat</code>. <code>vmstat</code> is great, it's outputting a lot of useful information. Let's see how it looks like before we start running the Docker containers:</p>
<div class="highlight"><pre><span></span>$ vmstat 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">463880</span>  <span class="m">51328</span> <span class="m">369012</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">635</span>    <span class="m">32</span>   <span class="m">94</span>  <span class="m">231</span>  <span class="m">2</span>  <span class="m">1</span> <span class="m">95</span>  <span class="m">1</span>  1
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">463356</span>  <span class="m">51336</span> <span class="m">369044</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">2</span>   <span class="m">36</span>   <span class="m">68</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">100</span>  <span class="m">0</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">462884</span>  <span class="m">51372</span> <span class="m">369116</span>    <span class="m">0</span>    <span class="m">0</span>    <span class="m">14</span>     <span class="m">2</span>   <span class="m">46</span>   <span class="m">69</span>  <span class="m">1</span>  <span class="m">0</span> <span class="m">99</span>  <span class="m">0</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">462380</span>  <span class="m">51372</span> <span class="m">369116</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span>   <span class="m">43</span>  <span class="m">101</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">100</span>  <span class="m">0</span>  0
</pre></div>


<p>The telling part here is the <code>id</code> column. That's the percentage which the CPU spends being idle. As you can see, the CPU is pretty idle. Not much to do.</p>
<p>We're then starting the first Docker container. Things spike up for a while. Let's observe vmstat:</p>
<div class="highlight"><pre><span></span>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">462380</span>  <span class="m">51372</span> <span class="m">369116</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span>   <span class="m">43</span>  <span class="m">101</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">100</span>  <span class="m">0</span>  0
<span class="c1"># Here&#39;s when we start the Docker container.</span>
 <span class="m">2</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">185252</span>  <span class="m">56072</span> <span class="m">497736</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">9159</span>  <span class="m">8016</span> <span class="m">2126</span> <span class="m">7829</span> <span class="m">22</span> <span class="m">14</span> <span class="m">43</span> <span class="m">21</span>  0
 <span class="m">1</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">95416</span>  <span class="m">56576</span> <span class="m">525740</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">1924</span>  <span class="m">1036</span>  <span class="m">396</span> <span class="m">1467</span> <span class="m">51</span> <span class="m">13</span> <span class="m">30</span>  <span class="m">7</span>  0
 <span class="m">1</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">147764</span>  <span class="m">56616</span> <span class="m">527408</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">336</span>   <span class="m">630</span>  <span class="m">117</span>  <span class="m">307</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">96</span>  <span class="m">1</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">65604</span>  <span class="m">56664</span> <span class="m">537452</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">82</span>   <span class="m">81</span>  <span class="m">494</span>  <span class="m">3</span>  <span class="m">3</span> <span class="m">94</span>  <span class="m">0</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">65556</span>  <span class="m">56676</span> <span class="m">537500</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">59</span>   <span class="m">59</span>  <span class="m">181</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">99</span>  <span class="m">1</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">65524</span>  <span class="m">56684</span> <span class="m">537504</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">58</span>   <span class="m">56</span>  <span class="m">179</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">99</span>  <span class="m">1</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">65400</span>  <span class="m">56692</span> <span class="m">537552</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>  <span class="m">4928</span>  <span class="m">138</span>  <span class="m">231</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">98</span>  <span class="m">2</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">65400</span>  <span class="m">56700</span> <span class="m">537552</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>  <span class="m">3187</span>  <span class="m">107</span>  <span class="m">201</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">98</span>  <span class="m">2</span>  0
</pre></div>


<p>Interesting. As you can see the <code>id</code> column value decreases. Less idleness, we're starting things. But after a while, the Docker container has started and we're back to things being quiet.</p>
<p>Let's see what <code>free</code> is saying:</p>
<div class="highlight"><pre><span></span>$ free -m
              total        used        free      shared  buff/cache   available
Mem:            <span class="m">990</span>         <span class="m">350</span>          <span class="m">59</span>          <span class="m">10</span>         <span class="m">580</span>         569
Swap:             <span class="m">0</span>           <span class="m">0</span>           0
</pre></div>


<p>So, <code>used</code> went up from 127MB to 350MB. The buffer cache also went up. Less available memory.</p>
<p>Let's start the second Docker container. We're looking at vmstat again.</p>
<div class="highlight"><pre><span></span>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">61304</span>  <span class="m">56740</span> <span class="m">537872</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">56</span>   <span class="m">83</span>  <span class="m">227</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">99</span>  <span class="m">1</span>  0
<span class="c1"># Starting second container here.</span>
 <span class="m">1</span>  <span class="m">1</span>      <span class="m">0</span> <span class="m">126516</span>  <span class="m">59292</span> <span class="m">341252</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">7109</span>  <span class="m">8100</span>  <span class="m">823</span> <span class="m">3255</span> <span class="m">22</span> <span class="m">15</span> <span class="m">56</span>  <span class="m">6</span>  0
 <span class="m">1</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">47572</span>  <span class="m">59904</span> <span class="m">337152</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">9186</span>  <span class="m">7515</span>  <span class="m">882</span> <span class="m">2316</span> <span class="m">51</span> <span class="m">13</span> <span class="m">17</span> <span class="m">19</span>  0
 <span class="m">0</span>  <span class="m">1</span>      <span class="m">0</span> <span class="m">153212</span>  <span class="m">59940</span> <span class="m">307720</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">1094</span>  <span class="m">2122</span>  <span class="m">214</span>  <span class="m">557</span>  <span class="m">2</span>  <span class="m">3</span> <span class="m">92</span>  <span class="m">3</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">92848</span>  <span class="m">59996</span> <span class="m">303368</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">556</span>   <span class="m">149</span>  <span class="m">147</span>  <span class="m">690</span>  <span class="m">2</span>  <span class="m">3</span> <span class="m">93</span>  <span class="m">1</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">92848</span>  <span class="m">60004</span> <span class="m">303368</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>   <span class="m">108</span>   <span class="m">91</span>  <span class="m">311</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">99</span>  <span class="m">0</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">92724</span>  <span class="m">60012</span> <span class="m">303376</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>   <span class="m">102</span>   <span class="m">94</span>  <span class="m">326</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">98</span>  <span class="m">1</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">88296</span>  <span class="m">60028</span> <span class="m">305048</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">320</span>   <span class="m">102</span>  <span class="m">147</span>  <span class="m">424</span>  <span class="m">2</span>  <span class="m">1</span> <span class="m">96</span>  <span class="m">2</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">77228</span>  <span class="m">60364</span> <span class="m">314520</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">1876</span>   <span class="m">144</span>  <span class="m">306</span>  <span class="m">868</span> <span class="m">28</span>  <span class="m">4</span> <span class="m">64</span>  <span class="m">4</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">86800</span>  <span class="m">60372</span> <span class="m">304968</span>    <span class="m">0</span>    <span class="m">0</span>    <span class="m">26</span>   <span class="m">387</span>  <span class="m">111</span>  <span class="m">372</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">97</span>  <span class="m">1</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">86032</span>  <span class="m">60780</span> <span class="m">305120</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">110</span>   <span class="m">119</span>  <span class="m">150</span>  <span class="m">399</span>  <span class="m">0</span>  <span class="m">0</span> <span class="m">98</span>  <span class="m">2</span>  0
</pre></div>


<p>Similar situation. A spike in io, a spike in non-idle CPU percentage, followed by quiet. Let's look at <code>free</code>:</p>
<div class="highlight"><pre><span></span>$ free -m
              total        used        free      shared  buff/cache   available
Mem:            <span class="m">990</span>         <span class="m">549</span>          <span class="m">84</span>          <span class="m">17</span>         <span class="m">356</span>         371
Swap:             <span class="m">0</span>           <span class="m">0</span> 
</pre></div>


<p>More used memory. But notice how this time the <code>buff/cache</code> section went down. Why? Well, because our running processes are using more memory and this memory has to come from somewhere. The kernel is freeing memory from the buffer cache and giving it to processes. Again, reasonable behavior.</p>
<p>Let's start the third and fourth Docker containers and see how <code>vmstat</code> looks after that.</p>
<div class="highlight"><pre><span></span>procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">46052</span>  <span class="m">11188</span> <span class="m">160564</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>   <span class="m">151</span>  <span class="m">153</span>  <span class="m">532</span>  <span class="m">0</span>  <span class="m">1</span> <span class="m">97</span>  <span class="m">2</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">39828</span>  <span class="m">11336</span> <span class="m">166664</span>    <span class="m">0</span>    <span class="m">0</span>  <span class="m">1246</span>   <span class="m">141</span>  <span class="m">235</span>  <span class="m">634</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">95</span>  <span class="m">4</span>  0
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">39704</span>  <span class="m">11344</span> <span class="m">166664</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>   <span class="m">149</span>  <span class="m">158</span>  <span class="m">542</span>  <span class="m">0</span>  <span class="m">1</span> <span class="m">97</span>  <span class="m">2</span>  0
<span class="c1"># After we start the fourth container.</span>
 <span class="m">6</span>  <span class="m">3</span>      <span class="m">0</span>  <span class="m">18840</span>  <span class="m">11668</span> <span class="m">179484</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">18678</span>  <span class="m">7726</span> <span class="m">2711</span> <span class="m">7721</span>  <span class="m">5</span>  <span class="m">8</span> <span class="m">46</span> <span class="m">41</span>  0
 <span class="m">1</span>  <span class="m">4</span>      <span class="m">0</span>   <span class="m">8964</span>   <span class="m">2796</span> <span class="m">103108</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">38137</span>  <span class="m">2508</span> <span class="m">4198</span> <span class="m">4872</span> <span class="m">37</span> <span class="m">21</span>  <span class="m">0</span> <span class="m">41</span>  1
 <span class="m">0</span> <span class="m">11</span>      <span class="m">0</span>   <span class="m">9576</span>    <span class="m">588</span> <span class="m">101548</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">68988</span>   <span class="m">485</span> <span class="m">4097</span> <span class="m">6006</span>  <span class="m">1</span> <span class="m">10</span>  <span class="m">0</span> <span class="m">88</span>  0
 <span class="m">0</span>  <span class="m">8</span>      <span class="m">0</span>   <span class="m">9352</span>    <span class="m">152</span> <span class="m">100752</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">67797</span>   <span class="m">250</span> <span class="m">2463</span> <span class="m">4497</span>  <span class="m">0</span>  <span class="m">8</span>  <span class="m">0</span> <span class="m">90</span>  1

....


 <span class="m">1</span> <span class="m">18</span>      <span class="m">0</span>   <span class="m">9508</span>    <span class="m">248</span> <span class="m">100560</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63568</span>   <span class="m">138</span> <span class="m">1700</span> <span class="m">3935</span>  <span class="m">0</span>  <span class="m">8</span>  <span class="m">0</span> <span class="m">91</span>  1
 <span class="m">0</span> <span class="m">14</span>      <span class="m">0</span>   <span class="m">8656</span>    <span class="m">400</span> <span class="m">100436</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63154</span>    <span class="m">68</span> <span class="m">1580</span> <span class="m">3766</span>  <span class="m">0</span>  <span class="m">8</span>  <span class="m">0</span> <span class="m">91</span>  1
 <span class="m">0</span> <span class="m">19</span>      <span class="m">0</span>   <span class="m">8852</span>    <span class="m">288</span> <span class="m">100552</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63711</span>   <span class="m">128</span> <span class="m">1606</span> <span class="m">3705</span>  <span class="m">0</span>  <span class="m">8</span>  <span class="m">0</span> <span class="m">92</span>  1
 <span class="m">1</span> <span class="m">47</span>      <span class="m">0</span>  <span class="m">10232</span>    <span class="m">372</span>  <span class="m">98616</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63410</span>    <span class="m">94</span> <span class="m">1720</span> <span class="m">4316</span>  <span class="m">0</span>  <span class="m">7</span>  <span class="m">0</span> <span class="m">91</span>  1
 <span class="m">2</span> <span class="m">50</span>      <span class="m">0</span>   <span class="m">9648</span>    <span class="m">420</span>  <span class="m">99604</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63126</span>    <span class="m">77</span> <span class="m">1696</span> <span class="m">4425</span>  <span class="m">0</span>  <span class="m">8</span>  <span class="m">0</span> <span class="m">91</span>  1
 <span class="m">0</span> <span class="m">40</span>      <span class="m">0</span>  <span class="m">10028</span>    <span class="m">272</span>  <span class="m">99432</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63692</span>    <span class="m">74</span> <span class="m">1681</span> <span class="m">4506</span>  <span class="m">0</span>  <span class="m">7</span>  <span class="m">0</span> <span class="m">91</span>  1
 <span class="m">0</span> <span class="m">75</span>      <span class="m">0</span>   <span class="m">9944</span>    <span class="m">160</span>  <span class="m">98220</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63342</span>    <span class="m">59</span> <span class="m">1724</span> <span class="m">5150</span>  <span class="m">0</span> <span class="m">10</span>  <span class="m">0</span> <span class="m">89</span>  1
 <span class="m">3</span> <span class="m">34</span>      <span class="m">0</span>   <span class="m">8952</span>    <span class="m">296</span> <span class="m">100400</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">63575</span>   <span class="m">110</span> <span class="m">1958</span> <span class="m">4663</span>  <span class="m">0</span>  <span class="m">8</span>  <span class="m">0</span> <span class="m">91</span>  1
 <span class="m">1</span>  <span class="m">5</span>      <span class="m">0</span>   <span class="m">9004</span>   <span class="m">1716</span> <span class="m">117640</span>    <span class="m">0</span>    <span class="m">0</span> <span class="m">62704</span>   <span class="m">123</span> <span class="m">2674</span> <span class="m">5329</span>  <span class="m">3</span>  <span class="m">9</span>  <span class="m">0</span> <span class="m">88</span>  1
</pre></div>


<p>This is where things start to get bad! The box becomes very unresponsive. Typing a simple command like <code>ls</code> takes seconds to execute. Let's take a peek at <code>free</code> and we'll continue to our analysis after that:</p>
<div class="highlight"><pre><span></span>$ free -m
              total        used        free      shared  buff/cache   available
Mem:            <span class="m">990</span>         <span class="m">851</span>          <span class="m">20</span>          <span class="m">24</span>         <span class="m">119</span>          54
Swap:             <span class="m">0</span>           <span class="m">0</span>           0
</pre></div>


<p>As you can see, we barely have any free memory and the buffer cache has shrunk even more. But notice what's going on in <code>vmstat</code>. The <code>bi</code> (blocks received from a block device) is stuck at a constant high value. This means we're doing a lot of disk reads. Why is that, are our processes doing a lot of disk operations? No. Our many processes are executables that are located on disk. When the kernel executes them, it has to read instructions. If we have enough buffer cache, we can store these instruction in memory and not have to read them again. However, our buffer cache is small now. So when processes run, the kernel needs to pull their instructions from disk. It probably stores them in the buffer cache, but when the next process is running, it tries to store in the cache again and evicts what's stored from the old process. </p>
<p>Are we done? Not yet. When this whole sad mess happens, the kernel will run something called <a href="https://linux-mm.org/OOM_Killer">OOM killer</a>. How do we know this is what's going on? We can use <code>dmesg</code> and view the system messages:</p>
<div class="highlight"><pre><span></span>$ dmesg <span class="p">|</span> grep <span class="s2">&quot;Out of memory&quot;</span>
<span class="o">[</span> 3635.537538<span class="o">]</span> Out of memory: Kill process <span class="m">21580</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">37</span> or sacrifice child
<span class="o">[</span> 3636.822607<span class="o">]</span> Out of memory: Kill process <span class="m">22714</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">37</span> or sacrifice child
<span class="o">[</span> 3643.006328<span class="o">]</span> Out of memory: Kill process <span class="m">24976</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">37</span> or sacrifice child
<span class="o">[</span> 3654.916468<span class="o">]</span> Out of memory: Kill process <span class="m">26118</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">37</span> or sacrifice child
<span class="o">[</span> 3658.712286<span class="o">]</span> Out of memory: Kill process <span class="m">28364</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">35</span> or sacrifice child
<span class="o">[</span> 3666.654763<span class="o">]</span> Out of memory: Kill process <span class="m">30603</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">36</span> or sacrifice child
<span class="o">[</span> 3685.390829<span class="o">]</span> Out of memory: Kill process <span class="m">30620</span> <span class="o">(</span>jupyter-noteboo<span class="o">)</span> score <span class="m">36</span> or sacrifice child
</pre></div>


<p>The strange thing here is that it keeps killing these <a href="http://jupyter.org/">Jupyter</a> processes for a long time. My guess here is that something restarts them after they're killed.</p>
<p>The best thing to do here is to simply kill all the running Docker containers so that the box is usable again:</p>
<div class="highlight"><pre><span></span>docker <span class="nb">kill</span> <span class="k">$(</span>docker ps -q<span class="k">)</span>
</pre></div>


<p>Things would look different if there was a swap partition on the disk. I might try such a setup as well. If you think about it, the swap would allow some of the memory used by processes to be transferred to disk. That's a great win, because some parts of memory might be very rarely if at all accessed. However, without a swap, there's no such option.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://pminkov.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <!--
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                  Blah blha blah
                </address>
        </footer>
        -->
        <!-- /#contentinfo -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-243631-7', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>