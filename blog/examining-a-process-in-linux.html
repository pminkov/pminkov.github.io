<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Examining a process in Linux.</title>
        <link rel="stylesheet" href="http://pminkov.github.io/blog/theme/css/main.css" />
        <link href="http://pminkov.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Petko's Coding Blog Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://pminkov.github.io/blog/">Petko's Coding Blog </a></h1>
                <nav><ul>
                    <li><a href="http://pminkov.github.io/blog/category/cloud.html">Cloud</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/django.html">Django</a></li>
                    <li class="active"><a href="http://pminkov.github.io/blog/category/linux.html">Linux</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/machine-learning.html">Machine Learning</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/misc.html">Misc</a></li>
                    <li><a href="http://pminkov.github.io/blog/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://pminkov.github.io/blog/examining-a-process-in-linux.html" rel="bookmark"
           title="Permalink to Examining a process in Linux.">Examining a process in Linux.</a></h1>
    </header>

    <div class="entry-content">
<div class="post-info">
        <div class="published" title="2017-03-01T12:26:00-08:00">
                Published: Wed 01 March 2017
in <a href="http://pminkov.github.io/blog/category/linux.html">Linux</a>
        </div>

</div><!-- /.post-info -->    </div>
    <div>
      <p>I've been thinking about writing a blog post about Linux tools and commands related to processes. Let's take a look at some of them.</p>
<p>The process that we'll be looking at is a <a href="https://github.com/pminkov/webserver">webserver</a> that I wrote some time ago to practice my C and write some code that does network related work. This webserver runs a <a href="https://github.com/pminkov/threadpool">threadpool</a> where N threads are waiting for server requests that they're going to execute.</p>
<p>So let's start the server:
<code>bash
$ ./server
Running on port: 8000</code></p>
<p>Great. So which process is this server running as? We can use the <code>pidof</code> command to find that out. Its output looks like this:</p>
<p><code>bash
$ pidof server
8876</code></p>
<p>If we had other processes which were running an executable with that name, we'd see more process ids, but since we only have one, we see one process id.</p>
<p>What next? Let's see how the process is layed out in memory. To do this, we can use the <code>pmap</code> command. Its output looks like this:</p>
<p><code>bash
$ sudo pmap -p 8876
8876:   ./server
0000000000400000     16K r-x-- /home/petko/work/github/webserver/server
0000000000603000      4K r---- /home/petko/work/github/webserver/server
0000000000604000      4K rw--- /home/petko/work/github/webserver/server
000000000110f000    132K rw---   [ anon ]
00007fd5ca731000      4K -----   [ anon ]
00007fd5ca732000   8192K rw---   [ anon ]
00007fd5caf32000      4K -----   [ anon ]
00007fd5caf33000   8192K rw---   [ anon ]
00007fd5cb733000      4K -----   [ anon ]
00007fd5cb734000   8192K rw---   [ anon ]
00007fd5cbf34000      4K -----   [ anon ]
00007fd5cbf35000   8192K rw---   [ anon ]
00007fd5cc735000   1792K r-x-- /lib/x86_64-linux-gnu/libc-2.23.so
00007fd5cc8f5000   2044K ----- /lib/x86_64-linux-gnu/libc-2.23.so
00007fd5ccaf4000     16K r---- /lib/x86_64-linux-gnu/libc-2.23.so
00007fd5ccaf8000      8K rw--- /lib/x86_64-linux-gnu/libc-2.23.so
00007fd5ccafa000     16K rw---   [ anon ]
00007fd5ccafe000     96K r-x-- /lib/x86_64-linux-gnu/libpthread-2.23.so
00007fd5ccb16000   2044K ----- /lib/x86_64-linux-gnu/libpthread-2.23.so
00007fd5ccd15000      4K r---- /lib/x86_64-linux-gnu/libpthread-2.23.so
00007fd5ccd16000      4K rw--- /lib/x86_64-linux-gnu/libpthread-2.23.so
00007fd5ccd17000     16K rw---   [ anon ]
00007fd5ccd1b000    152K r-x-- /lib/x86_64-linux-gnu/ld-2.23.so
00007fd5ccf22000     12K rw---   [ anon ]
00007fd5ccf3e000      8K rw---   [ anon ]
00007fd5ccf40000      4K r---- /lib/x86_64-linux-gnu/ld-2.23.so
00007fd5ccf41000      4K rw--- /lib/x86_64-linux-gnu/ld-2.23.so
00007fd5ccf42000      4K rw---   [ anon ]
00007ffca0861000    132K rw---   [ stack ]
00007ffca09eb000      8K r----   [ anon ]
00007ffca09ed000      8K r-x--   [ anon ]
ffffffffff600000      4K r-x--   [ anon ]
total            39316K</code></p>
<p>What you see here are virtual memory addresses. For example, let's take a look at this line:</p>
<p><code>00007fd5cc735000   1792K r-x-- /lib/x86_64-linux-gnu/libc-2.23.so</code></p>
<p>This is the code for <code>libc</code>, which is the C standard library. This code is shared between processes that need it. We can see the <code>x</code> flag, which means that this is executable memory. The size if roughly the same as the size of this <code>so</code> file. This library is memory mapped into a region starting at address <code>00007fd5cc735000</code>, but in physical memory it's only stored in one place. To learn more about memory in Linux, here's a <a href="https://techtalk.intersec.com/2013/07/memory-part-1-memory-types/">great post</a> going into detail about it.</p>
<p>Another interesting command is <code>lsof</code>. <code>lsof</code> stands for "list of open files". Let's see its output:</p>
<p><code>bash
$ sudo lsof -p 8876
COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
server  8876 petko  cwd    DIR    8,1     4096  262299 /home/petko/work/github/webserver
server  8876 petko  rtd    DIR    8,1     4096       2 /
server  8876 petko  txt    REG    8,1    25536  306491 /home/petko/work/github/webserver/server
server  8876 petko  mem    REG    8,1  1864888 1184834 /lib/x86_64-linux-gnu/libc-2.23.so
server  8876 petko  mem    REG    8,1   138744 1184980 /lib/x86_64-linux-gnu/libpthread-2.23.so
server  8876 petko  mem    REG    8,1   162632 1184806 /lib/x86_64-linux-gnu/ld-2.23.so
server  8876 petko    0u   CHR  136,9      0t0      12 /dev/pts/9
server  8876 petko    1u   CHR  136,9      0t0      12 /dev/pts/9
server  8876 petko    2u   CHR  136,9      0t0      12 /dev/pts/9
server  8876 petko    3u  IPv4  81993      0t0     TCP *:8000 (LISTEN)</code></p>
<p>As you can see, we have file descriptors 0,1 and 2, which are stdin, stdout and stderr. They are linked to the terminal in which the process is running in. You can write to that terminal btw. Just type <code>echo "hello world" &gt; /dev/pts/9</code> and you'll see that text in the terminal where your webserver is running. File descriptor number 3 is our socket which accepts connections.</p>
<p>Another interesting way to inspect processes is the ps command. Its basic output looks like this:
<code>bash
$ ps --pid 8876
  PID TTY          TIME CMD
 8876 pts/9    00:00:00 server</code></p>
<p>This is simple. We can also show the threads inside a process, like this:</p>
<p><code>bash
$ ps  m --pid 8876 -o pid,tid,cmd
  PID   TID CMD
 8876     - ./server
    -  8876 -
    -  8877 -
    -  8878 -
    -  8879 -
    -  8880 -</code></p>
<p>We have five threads here. One is our main thread and the other four are the threadpool threads. The <code>m</code> option tells ps to show the threads of a process. The <code>-o</code> option specifies fields to output. We can even get fancy and output the addresses of the threads' stack pointers and instruction pointers, like this:
<code>bash
$ ps  m --pid 8876 -o pid,tid,cmd,esp,eip
  PID   TID CMD                              ESP      EIP
 8876     - ./server                           -        -
    -  8876 -                           a0880b70 ccb0e7ad
    -  8877 -                           cc733ec0 ccb0b3a0
    -  8878 -                           cbf32ec0 ccb0b3a0
    -  8879 -                           cb731ec0 ccb0b3a0
    -  8880 -                           caf30ec0 ccb0b3a0</code></p>
<p>So all the threads are at the same instruction, but they have different stack pointers, which makes sense. If I execute something on one of the threads, both the <code>ESP</code> and <code>EIP</code> can possibly change.</p>
<p>A lot of data about processes lives in the <code>proc</code> filesytem, located in <code>/proc</code>. For each running process, there's a subdirectory of <code>/proc</code> named after the process id. For example, for our process <code>8876</code>, there's a <code>status</code> file which lists various information about the process. Let's look at it:</p>
<p><code>bash
$ cat /proc/8876/status
Name:   server
State:  S (sleeping)
Tgid:   8876
Ngid:   0
Pid:    8876
PPid:   2604
TracerPid:      0
Uid:    1000    1000    1000    1000
Gid:    1000    1000    1000    1000
FDSize: 256
Groups: 4 24 27 30 46 113 128 999 1000 
NStgid: 8876
NSpid:  8876
NSpgid: 8876
NSsid:  2604
VmPeak:    39316 kB
VmSize:    39316 kB
VmLck:         0 kB
VmPin:         0 kB
VmHWM:       800 kB
VmRSS:       800 kB
VmData:    32988 kB
VmStk:       136 kB
VmExe:        16 kB
VmLib:      2040 kB
VmPTE:        48 kB
VmPMD:        12 kB
VmSwap:        0 kB
HugetlbPages:          0 kB
Threads:        5
SigQ:   0/7848
SigPnd: 0000000000000000
ShdPnd: 0000000000000000
SigBlk: 0000000000000000
SigIgn: 0000000000000000
SigCgt: 0000000180000000
CapInh: 0000000000000000
CapPrm: 0000000000000000
CapEff: 0000000000000000
CapBnd: 0000003fffffffff
CapAmb: 0000000000000000
Seccomp:        0
Cpus_allowed:   1
Cpus_allowed_list:      0
Mems_allowed:   00000000,00000001
Mems_allowed_list:      0
voluntary_ctxt_switches:        3
nonvoluntary_ctxt_switches:     2</code></p>
<p>There's a lot of data in here, but remember how we used <code>ps</code> to count the number of threads in this process. That's also available here on the line saying <code>Threads:    5</code>.</p>
<p>Our last command is <code>pidstat</code>. <code>pidstat</code> shows statistics about a running process, which can be updated at a regular time interval. A possible invocation can be:</p>
<p>```bash
$ pidstat -p 8876 1
Linux 4.4.0-64-generic (virtbox)        03/01/2017      <em>x86_64</em>        (1 CPU)</p>
<p>12:22:00 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
12:22:01 PM  1000      8876    0.00    0.00    0.00    0.00     0  server
12:22:02 PM  1000      8876    0.00    0.00    0.00    0.00     0  server
```</p>
<p>Our server is not doing anything right now, so you see a lot of zeroes.</p>
<p>There are many other interesting commands that you can look to figure out what processes are doing. <code>strace</code> shows system calls run by a process. <code>ltrace</code> shows dynamic library calls. <code>tcpdump</code> can be used to show traffic going in and out of a process.</p>
<p>So, that's all for today. Happy running of processes.</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'pminkov-blog';
        var disqus_identifier = 'examining-a-process-in-linux.html';
        var disqus_url = 'http://pminkov.github.io/blog/examining-a-process-in-linux.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//pminkov-blog.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://pminkov.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <!--
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                  Blah blha blah
                </address>
        </footer>
        -->
        <!-- /#contentinfo -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-243631-7', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript">
    var disqus_shortname = 'pminkov-blog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>