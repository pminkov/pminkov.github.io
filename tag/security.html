<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Petko's Coding Blog - Security</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Petko's Coding Blog </a></h1>
                <nav><ul>
                    <li><a href="/category/aws.html">AWS</a></li>
                    <li><a href="/category/django.html">Django</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/how-to-generate-user-activation-links-in-django.html">How to generate user activation links in Django</a></h1>
<div class="post-info">
        <abbr class="published" title="2016-04-05T17:03:00-07:00">
                Published: Tue 05 April 2016
in <a href="/category/python.html">Python</a>
        </abbr>
<p>Tags: <a href="/tag/python.html">Python</a> <a href="/tag/django.html">Django</a> <a href="/tag/security.html">Security</a> <a href="/tag/cryptography.html">Cryptography</a> </p>
</div><!-- /.post-info --><p>Imagine the following simple user registration flow:</p>
<ol>
<li>User registers by setting an e-mail and a password.</li>
<li>The server sends an e-mail containing an activation link to the user.</li>
<li>The user clicks on the activation link and activates their account.</li>
</ol>
<p>Let's focus on step 2. How do we generate this activation link?</p>
<p>One way to implement this is to generate single use tokens and save them in a database table. Our url then looks like <code>http://sitename.com/activate?token=mytoken</code>. That solution has the benefit of being able to track that a token has been used and enforce single use. The drawback is that you need a new database table, which I wanted to avoid.</p>
<p>How else can we generate these tokens?</p>
<p>My first hunch was to reuse Django's <a href="https://github.com/django/django/blob/master/django/contrib/auth/tokens.py">PasswordResetTokenGenerator</a>. However, notice that the <code>check_token</code> function requires a user. This means that the activation link needs to include information about who the user is. So our <code>/activate</code> link will need to include an url parameter that's either the username, user id, or something else that uniquely identifies a user. I'm not happy with that. This is a link that's supposed to be private and I don't want the user's first impression of my site to be that I'm including their user id in an activation link, when most other sites don't do that.</p>
<p>The solution that I settled on was encrypting the user id on the server. I'm generating a link of the form <code>http://sitename.com/activate?token=mytoken</code>. I generate the token using the Python <a href="https://pypi.python.org/pypi/cryptography">cryptography</a> package. The token is created by encrypting the username with a salt.</p>
<p>So why is this not what Django is doing? I suppose the answer is that Python doesn't have a symmetric encryption implementation library coming with it.</p>
<p>In addition, I also wanted the tokens to expire. This is simple, we can just include a timestamp in the token and compare it against the current time upon decryption.</p>
<p>Here's a sample class that implements all of this:</p>
<script src="https://gist.github.com/pminkov/e53d90c348f1dc47553408666431d2a2.js"></script>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-243631-7', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>